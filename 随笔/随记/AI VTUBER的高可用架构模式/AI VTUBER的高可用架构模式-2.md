书接上回。

我们对这个架构进行更进一步的细分认知。这样一个工作流就好比某种加工厂——就拿水果罐头加工厂来举例吧。譬如现在有一片苹果林，一片黄桃林。采摘的过程不是这个架构本身要关心的事情，这个部分具体在整个工作流的input源处实现。现在果农把苹果和黄桃送过来了，果子从input源滚出来，奔向了生产线上。各种节点就是一系列处理过程——诸如去皮，切块，灌装等等。而节点和节点之间就是暴露的传送带，连接着节点和节点之间的接口。通过一系列的处理操作，我们最后看到的就是苹果罐头或者奶龙尸块罐头，呈递给output出口，呈现给用户。

水果罐头工程加工的是水果，那我们要加工的是什么？以我来看，我们要加工的是信息。信息在工作流里流动，被筛选，被处理，从一段纯粹的string变成了有音频带情感向量等等的东西。甚至不必是string。

私以为关键的地方应当是对节点的类型定义。从流水线角度讲，节点无非输入-处理-输出三种。然而要实现处理灵活，我们应当做到对信息进行筛选、剔除、分流等操作，实现一个if节点就显得很有必要。当然，就算我们实现了if的选择模式，通过节点组合形式形成的工作流程可能也没有硬上代码强。但是如果设计得足够好，把该暴露的值暴露出来交给if去筛查，最后的效果应该也不会太差。之后我们还可以基于if去设计一些比如能够影响优先级的节点。

鉴于管人直播的特殊性——弹幕源源不断，但是管人只有一张嘴，所以流进生产线的消息都应当包含某种优先级，系统会优先处理优先级最高的消息。鉴于此，理应有一个门卫挑选最好的果汁，而且传送带应当走走停停。`GoAtuber`在设计时的一个问题就是优先队列后的“生产线”每次只能处理一条消息，造成了资源的闲置。事实上，在第一条消息TTS的时候，第二条消息已经可以呈递给LLM了。这本身也是生产线的精髓，想必玩过异星工厂或戴森球计划的人都很清楚这一点。

我们就以最简单的一条AI Vtuber流程做初步的分析。

```
弹幕送入-（过滤器过滤）-优先队列-LLM生成回应-过滤器过滤-TTS-呈递给前端              
```

弹幕消息是源源不断送入处理流程中的，而在送入时，input源会给每个消息打上一些标签和值。之后经过过滤，系统再根据消息送入时的标签和权值计算出优先度，放入优先队列中去。到达优先队列之后，消息就被阻滞了。而系统会挑选优先级最高（目前来看，最适合干这活的还是heap）的那条消息进入下一步的流程中去，假设这里有优先级最高的消息A和优先级次高的消息B，当A完成LLM这一步进入过滤器时，B实际上就可以马上进入到LLM中去了。