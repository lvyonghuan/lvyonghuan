### **第八章 嵌入式文件系统 \- 考点总结**

#### **1\. 常见的FLASH文件系统 (填空题考点)**

Flash存储器由于其“先擦除后写入”、有限擦写次数、坏块等特性，不能直接使用像ext2、FAT等传统磁盘文件系统。因此，诞生了专门为Flash设计的文件系统。

* **JFFS2 (Journalling Flash File System v2)**:  
  * 一种日志型文件系统，可读写，支持数据压缩。  
  * 提供了掉电安全保护和“损耗均衡”(Wear Leveling)支持。  
  * 主要为 **NOR Flash** 设计。在挂载时需要扫描整个分区以建立文件结构，因此不适合大容量的NAND Flash。  
* **YAFFS / YAFFS2 (Yet Another Flash File System)**:  
  * 另一种日志型文件系统，专为 **NAND Flash** 设计。  
  * 相比JFFS2，挂载速度更快，内存占用更小。  
  * YAFFS支持小页(512B)NAND，YAFFS2支持大页(2KB)及以上NAND，性能更好。  
* **CRAMFS (Compressed ROM File System)**:  
  * 一个**只读**的压缩文件系统。  
  * 特点是文件数据以页为单位进行压缩存放，在运行时解压到RAM中。  
  * 优点是极大地节省了Flash存储空间。  
  * 缺点是不能原地执行(XIP)，且文件系统大小固定，无法扩展。  
* **ROMFS**:  
  * 一个非常简单的、紧凑的、**只读**的文件系统。  
  * 不支持数据压缩，数据按顺序存放。  
  * 主要优点是支持**应用程序原地执行 (XIP)**，无需加载到RAM，启动速度快。

#### **2\. 如何创建根文件系统 (简答题考点)**

根文件系统(Root Filesystem)是内核启动后挂载的第一个文件系统，它包含了Linux系统运行所必需的所有目录、配置文件、库文件和应用程序。创建一个基本的嵌入式Linux根文件系统通常包括以下步骤：

1. 创建基本的目录结构:  
   首先，创建一个作为根文件系统顶层的目录（例如rootfs），然后在其中创建Linux标准的子目录。对于嵌入式系统，最核心的目录包括：  
   * /bin: 存放必要的用户命令（二进制可执行文件），如ls, cat, sh。  
   * /sbin: 存放必要的系统管理员命令，如init, ifconfig, mount。  
   * /etc: 存放系统配置文件，如inittab, fstab, passwd。  
   * /lib: 存放系统运行所必需的共享链接库（如C库）和内核模块。  
   * /dev: 存放设备文件节点。  
   * /proc, /sys: 用于与内核交互的虚拟文件系统挂载点。  
   * /usr, /tmp, /var 等。  
2. 拷贝必要的库文件:  
   将交叉编译工具链中的C库（如glibc, uClibc）等动态链接库文件，复制到根文件系统的/lib目录下。应用程序在运行时需要链接这些库。  
3. 创建设备文件:  
   在/dev目录下创建必要的设备文件节点。有三种方法：  
   * **手动创建**: 使用mknod命令手动创建，需要知道设备的主/次设备号。例如：mknod \-m 666 console c 5 1。  
   * **使用devfs**: 如果内核配置支持，devfs可以在系统启动时自动创建设备节点。  
   * **使用udev**: 这是目前主流的方式。udev是一个用户空间的守护进程，它能动态地根据内核检测到的硬件来创建和删除/dev下的设备文件。  
4. 添加系统应用程序:  
   嵌入式系统资源有限，不能把PC上所有的命令都放进去。通常使用BusyBox来解决这个问题。BusyBox被称为“嵌入式Linux的瑞士军刀”，它将大量常用的Linux命令（如ls, mv, mount, vi等）集成到了一个单一的可执行文件中。我们只需要编译BusyBox，并将其安装到/bin目录下，然后为各个命令创建指向它的符号链接即可。  
5. 配置系统初始化文件:  
   在/etc目录下创建关键的系统初始化脚本。最主要的是inittab文件（或者init.d/rcS脚本），它被系统的第一个进程init（通常也由BusyBox提供）读取，用来定义系统启动时要执行的脚本、启动的服务、打开的控制台等。

完成以上步骤后，一个基本的根文件系统就制作好了，可以将其烧写到Flash中，供系统启动时挂载。

#### **思考题解答**

1. **文件系统的功能是什么？**  
   * 从系统角度看，文件系统负责对存储空间的组织、分配和回收，以及对文件本身的存储、检索、共享和保护。  
   * 从用户角度看，文件系统实现了“按名存取”，让用户可以通过文件名方便地存储和读取数据，而无需关心数据在物理介质上的具体位置。  
2. **了解嵌入式文件系统设计的特点。**  
   * 嵌入式文件系统的设计目标各不相同，通常需要考虑：  
     * **性能**: 安全可靠，有掉电保护能力；实时响应能力强；高效利用有限的存储资源。  
     * **功能**: 可根据需求进行伸缩和配置；支持多种文件类型。  
     * **扩展性**: 具有开放的体系结构和标准接口，便于移植。  
3. **Linux虚拟文件系统设计的主要思想是什么？**  
   * 主要思想是**抽象和统一接口**。VFS在内核的系统调用接口和具体的文件系统实现之间增加了一个中间层。应用程序通过统一的VFS接口（如open, read, write）来操作文件，VFS再根据文件所在的具体文件系统类型（如ext4, JFFS2），调用该文件系统注册给VFS的相应函数（通过file\_operations结构体实现关联），从而屏蔽了底层文件系统的差异。  
4. **Flash设备的特性，有什么问题？**  
   * **特性**: 非易失性、固态存储、抗震、低功耗。分为NOR型（支持随机访问，可原地执行XIP）和NAND型（容量大、成本低，按页/块访问）。  
   * **问题**:  
     * **先擦除再写入**: 写入操作只能将1变为0，不能将0变为1。所以修改数据前，必须先擦除整个块，将所有位恢复为1。  
     * **有限的擦写寿命**: 每个块的擦除次数是有限的，频繁擦写同一个块会导致其损坏。这引出了\*\*损耗均衡(Wear Leveling)\*\*的需求。  
     * **坏块(Bad Block)**: NAND Flash出厂时就可能存在坏块，在使用中也可能产生新的坏块，文件系统必须能够识别和跳过这些坏块。  
     * **掉电保护**: 突然断电可能导致文件系统元数据和用户数据不一致，需要有机制来恢复。  
5. **Flash的主要文件系统及其特点。**  
   * 已在上方考点1“常见的FLASH文件系统”中详细解答。主要有JFFS2, YAFFS, CRAMFS, ROMFS。  
6. **RAM文件系统有哪些，及其应用场景。**  
   * **Ramdisk**: 将一块固定大小的内存模拟成块设备（硬盘分区）。需要格式化才能使用。可以作为临时的根文件系统。  
   * **Ramfs/tmpfs**: 直接在内存中实现的文件系统，不需要块设备层，大小可动态变化。它们非常快，但断电后数据会丢失。  
   * **应用场景**: 用于存放临时文件或经常修改的数据，如/tmp和/var目录，以提高速度并避免对Flash的损耗。  
7. **网络文件系统。**  
   * 最典型的是**NFS (Network File System)**。它允许一个系统通过网络挂载另一台服务器上的目录，并像访问本地文件一样访问远程文件。在嵌入式开发中，常用于将宿主机的开发目录挂载为目标板的根文件系统，这样修改代码后无需重新烧写，直接在目标板上就能看到效果，极大提高了开发效率。  
8. **根文件系统。**  
   * 根文件系统是内核在启动过程中挂载的**第一个文件系统**。它包含了启动和运行一个最基本的Linux系统所需要的所有文件，包括init程序、系统配置文件、核心命令、设备文件和库文件。没有根文件系统，系统将无法完成启动。  
9. **如何生成一个根文件系统？**  
   * 已在上方考点2“如何创建根文件系统”中详细解答。