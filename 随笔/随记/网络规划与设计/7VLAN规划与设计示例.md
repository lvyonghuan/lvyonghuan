1. 设计要求：
用户1 172.16.1.0/24至出口1 172.16.100.0/24
用户2 192.168.1.0/24至出口2 192.168.100.0/24
用户1通过互联网出口1，用户2通过互联网出口2

```
出口1               出口2
  |                    |   
172.16.100.253       192.168.100.253
  |                    |
172.16.100.254       192.168.100.254
  |                    |
             三层交换机
  |                    |
172.16.1.254         192.168.1.254
  |                    |
172.16.1.0           192.168.1.0      
```

# 生成树协议和快速生成树协议
解决环路的算法是生成树算法

STP虽然能解决环路问题，但是由于网络拓扑收敛慢，影响用户通信质量。如果结构频繁变化，网络也会随之频繁失去连通性，导致用户通信频繁中断。

由于STP的不足，发布了RSTP。

## 生成树协议端口角色解析

在交换机中，BP RP DP端口是生成树协议中的端口角色的缩写，用于描述端口在生成树拓扑中的不同状态和功能。

BPDU是生成树协议中交换机之间交换的报文。

BPDU携带的信息：根桥ID、根桥开销路径、发送桥ID、端口ID、计时器等。

- 根端口（RP）：是距离根桥最近的端口（开销最小），负责将数据包转发到根桥。
- 指定端口（DP）：每个网段中负责向根桥方向转发数据包的端口。是网段当中的最优端口（到达根桥的开销最小）。
- 阻塞端口（BP）：不转发数据包，处于阻塞状态。备份。

## RSTP的角色重新划分

重新定义了备份端口和替代端口。

将原来的五种状态缩减为了三种状态：
- 转发状态（Forwarding）：端口处于转发状态，能够接收和发送数据帧。
- 学习状态（Learning）：端口处于学习状态，能够接收数据帧，但不转发数据帧。用于学习MAC地址。
- 丢弃状态（Discarding）：端口处于丢弃状态，既不接收也不转发数据帧。用于防止环路。

----

# 基于协议的VLAN划分

基于协议的VLAN划分是根据端口接收到的报文所属的协议类型及封装格式来个报文分配不同的VLAN ID。可以用来划分VLAN的协议育IP IPX AppleTalk，封装格式有Ethernet ii等。

协议类型+封装格式称为协议模板。一个协议VLAN可以绑定多个协议模板。

---

# 基于子网的VLAN划分
基于IP子网的vlan根据报文源IP地址及子网掩码来进行划分。设备从端口接收到untagged报文之后，根据源地址来确定所属的vlan，然后将报文自动化分到指定vlan传输。

---

例如将PC A和PC B根据子网划分到不同的VLAN中。

```
       +--------+
       | Switch |
       +--------+
           | GE 3/0/1
           |
    +-----------+
    | L2 Switch |
    +-----------+
       /       \
      /         \
+--------------+   +--------------+
|     PC A     |   |     PC B     |
| VLAN 10      |   | VLAN 20      |
| 1.1.1.0/24   |   | 2.1.1.0/24   |
+--------------+   +--------------+

```