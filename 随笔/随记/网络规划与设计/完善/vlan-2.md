**VLAN 扩展规划与设计讲义**

**引言**
在基本的VLAN划分之后，网络往往需要更高级的功能，如VLAN间的通信、策略路由以及在冗余链路环境下的环路避免。本讲义将重点介绍三层交换机如何实现VLAN间路由，以及生成树协议（STP）及其快速版本（RSTP）在构建无环路、高可用交换网络中的作用和配置。

---

**一、三层交换与VLAN间路由**

1.  **三层交换机概述** (参考P2-P3)
    *   **核心功能**：通过硬件实现数据包的交换和路由选择，达到“一次路由，多次转发”的高效处理。
    *   **技术基础**：常使用MLS (Multilayer Switching) 或基于CEF (Cisco Express Forwarding) 的体系结构。
        *   **CEF**：基于拓扑转发模型，包含转发信息表 (FIB - 主机IP+对应VLAN) 和邻接关系表 (主机MAC+交换机MAC)。
    *   **工作流程**：主机A发送数据到主机B（不同VLAN），三层交换机查找MLS条目（FIB+邻接关系），知道主机B的地址后，直接将数据硬件转发。虚拟的路由功能仅在首次建立流或拓扑变化时介入。

2.  **VLAN间路由的实现：SVI (交换虚拟接口)** (参考P4-P5)
    *   **概念**：三层交换机为每个需要路由的VLAN创建一个逻辑的三层接口，称为SVI (Switch Virtual Interface) 或 VLAN接口。
    *   **配置IP地址**：SVI上配置IP地址，该地址作为对应VLAN内主机的网关地址。
    *   **示例 (P4)**：
        *   PC1 (192.168.0.2/24) 属于 VLAN 10，网关为 VLAN 10 的SVI IP (192.168.0.1/24)。
        *   PC (192.168.1.2/24) 属于 VLAN 20，网关为 VLAN 20 的SVI IP (192.168.1.1/24)。
        *   物理端口 E1/1 划入 VLAN 10，E1/2 划入 VLAN 20。
    *   **通信流程 (P5)**：
        *   **Access接入模式**：主机A (VLAN10) 要访问主机B (VLAN20)。
            1.  A将数据包发往其网关 (VLAN10 SVI)。
            2.  三层交换机查询路由表，找到达VLAN20的路径。
            3.  数据包通过VLAN20 SVI转发给主机B。
        *   **Trunk中继模式**：如果SVI分布在不同物理交换机上，或者需要汇聚，Trunk链路用于承载多个VLAN的流量。

3.  **基于三层交换的策略路由示例** (参考P6-P8)
    *   **设计需求**：
        1.  用户1网络 (172.16.1.0/24) 访问互联网走出口1 (网关172.16.100.253/32)。
        2.  用户2网络 (192.168.1.0/24) 访问互联网走出口2 (网关192.168.100.253/32)。
    *   **三层交换机IP规划**：
        *   SVI (用户1网关): 172.16.1.254/24
        *   SVI (用户2网关): 192.168.1.254/24
        *   SVI (连接出口1): 172.16.100.254/32
        *   SVI (连接出口2): 192.168.100.254/32
    *   **配置步骤概述**：
        1.  **配置1 (VLAN创建)**：创建管理VLAN1及各业务VLAN (100, 101, 102, 103)。
        2.  **配置2 (SVI IP地址)**：为各VLAN接口配置IP地址作为网关。
            *   VLAN1 (管理): 192.168.0.254
            *   VLAN100 (映射用户2网络): 192.168.100.254 (作为出口2的本地接口)
            *   VLAN101 (用户2网关): 192.168.1.254
            *   VLAN102 (映射用户1网络): 172.16.100.254 (作为出口1的本地接口)
            *   VLAN103 (用户1网关): 172.16.1.254
        3.  **配置3 (端口模式)**：配置连接用户和互联网出口的物理端口类型 (Access/Trunk) 并划入相应VLAN。
        4.  **配置4 (默认路由)**：配置一条默认静态路由指向其中一个出口 (如出口2: 192.168.100.253)，用于非策略匹配的流量。
        5.  **配置5 (流分类ACL)**：创建ACL 3001匹配用户1网络 (172.16.1.0/24) 的流量。
        6.  **配置6 (流行为)**：定义流行为，将匹配ACL 3001的流量重定向到下一跳出口1 (172.16.100.253)。
        7.  **(隐式) 应用策略**：通常需要将ACL和流行为绑定到QoS策略或路由策略中，并应用到相应的SVI入方向。

---

**二、交换网络冗余与环路避免：生成树协议 (STP)**

1.  **冗余链路与环路问题** (参考P9-P10)
    *   **冗余链路**：为提高网络可用性，通常会部署冗余链路。
    *   **环路风险**：冗余链路可能导致二层环路，引发广播风暴、MAC地址表不稳定、多帧复制等问题。

2.  **生成树协议 (STP) 原理** (参考P11)
    *   **目标**：在物理上存在环路的网络中，通过逻辑上阻塞某些端口，构建一棵无环路的树形拓扑。
    *   **工作步骤**：
        1.  **选举根桥 (Root Bridge)**：网络中选举一个唯一的根桥。
        2.  **选举根端口 (Root Port - RP)**：每个非根桥上选举一个离根桥最近的端口作为根端口。
        3.  **选举指定端口 (Designated Port - DP)**：每个物理网段选举一个指定端口，负责该网段向根桥方向转发流量。
        4.  **阻塞端口 (Blocked Port - BP/Non-Designated Port)**：非根端口、非指定端口被阻塞，不转发用户数据，只侦听BPDU。

3.  **STP的不足** (参考P12, P35-P41)
    *   **收敛慢**：从初始状态到完全收敛至少需要30s (甚至50s)，拓扑变化时恢复慢 (Listening 15s + Learning 15s)。
    *   **端口状态复杂**：Disabled, Blocking, Listening, Learning, Forwarding。其中Blocking, Listening, Learning对用户而言行为相似（不转发数据），增加了理解难度。
    *   **端口角色有限**：主要是RP, DP, BP。
    *   **拓扑变更机制复杂低效**：TCN消息逐级上报至根桥，再由根桥通告全网，效率低。

---

**三、快速生成树协议 (RSTP) 及其改进**

1.  **RSTP概述** (参考P12, P42-P43)
    *   IEEE 802.1w标准，对STP进行了改进，实现二层网络拓扑的快速收敛。

2.  **RSTP端口角色** (参考P14-P34, P42)
    *   **根端口 (Root Port - RP)**：同STP，非根交换机去往根桥路径开销最小的端口。转发状态。
    *   **指定端口 (Designated Port - DP)**：同STP，每个网段向根桥转发流量的端口。转发状态。
    *   **预备端口 (Alternate Port - AP)**：RP的备份。提供了到根桥的另一条路径，但被阻塞。当RP失效，AP快速成为新的RP并进入转发状态。
    *   **备份端口 (Backup Port - BP)**：DP的备份。当一个交换机有多个端口连接到同一共享网段，其中一个成为DP，其他可成为BP。阻塞状态。(此处的BP与STP的阻塞端口含义略有不同，更强调是DP的备份)
    *   **阻塞端口 (Blocked Port / BP 在展示中指通用阻塞)**：逻辑上断开，不学习MAC，不转发数据，仅接收BPDU。 (P17-P20 详解)
    *   **边缘端口 (Edge Port)**：连接终端设备的端口，不参与生成树计算，可立即进入转发状态。

3.  **RSTP端口状态** (参考P43)
    *   将STP的5种状态简化为3种：
        *   **Discarding (丢弃)**：不转发用户流量，不学习MAC地址。(对应STP的Disabled, Blocking, Listening)
        *   **Learning (学习)**：不转发用户流量，但学习MAC地址。
        *   **Forwarding (转发)**：既转发用户流量，也学习MAC地址。

4.  **RSTP快速收敛机制**
    *   **P/A机制 (Proposal/Agreement)** (参考P44-P46)：
        *   用于点对点链路，通过“提议-同意”的握手过程，使端口快速进入转发状态，无需等待计时器。
        *   根桥的DP端口发送P置位的BPDU，下游交换机收到后，阻塞其他非边缘端口，选择该端口为RP，回复A置位的BPDU。
    *   **根端口快速切换** (参考P47)：如果RP失效，AP（预备端口）立即切换为RP并进入转发状态 (秒级)。
    *   **次等BPDU处理机制** (参考P48)：当链路激活或新交换机加入，收到次等BPDU的端口会立即发送本地最优BPDU，加速拓扑收敛。
    *   **边缘端口 (Edge Port)** (参考P49)：连接终端的端口配置为边缘端口，不参与STP计算，直接进入转发状态。收到BPDU后，丧失边缘端口属性，重新参与计算。
    *   **拓扑变更 (TC) 机制优化** (参考P50-P55)：
        *   **触发条件**：只有非边缘端口迁移到Forwarding状态才触发TC。
        *   **TC通告**：发生拓扑变更的交换机直接向全网泛洪TC置位的BPDU，而不是先通知根桥。
        *   **MAC地址老化**：收到TC BPDU后，交换机清除非边缘端口学习到的MAC地址（除了收到TC BPDU的端口）。

5.  **RSTP增强特性 (安全保护)**
    *   **BPDU保护 (BPDU Guard)** (参考P56-P57)：
        *   用于边缘端口。如果启用了BPDU保护的边缘端口收到BPDU，端口会被err-disabled关闭，防止非法设备接入影响生成树。
    *   **根保护 (Root Guard)** (参考P58-P59)：
        *   用于不希望成为根桥路径上的DP端口。如果启用了根保护的端口收到更优的BPDU（可能导致本交换机或下游成为根），该端口会进入discarding状态，不转发该BPDU，以保护现有根桥的地位。
    *   **TC-BPDU泛洪保护** (参考P60-P61)：
        *   限制单位时间内处理TC-BPDU的次数，防止恶意攻击或网络震荡导致CPU过载。

---

**四、RSTP配置示例** (参考P63-P66)

1.  **需求**：SWA, SWB, SWC组成环形网络，消除环路，PC1和PC2正常通信。
2.  **配置思路**：
    *   所有交换机启用RSTP。
    *   SWA配置为根桥 (`stp root primary`)。
    *   连接PC的端口 (如SWB G0/0/4, SWC G0/0/4) 配置为边缘端口 (`stp edged-port enable`) 并启用BPDU保护 (`stp bpdu-protection`)。
3.  **验证**：
    *   `display stp brief`：查看端口角色和状态。
        *   SWA: 所有活动端口为DESI (Designated), FORWARDING。
        *   SWB: 一个ROOT端口, FORWARDING；一个DESI端口, FORWARDING；连接PC的DESI端口, FORWARDING (BPDU保护)。
        *   SWC: 一个ROOT端口, FORWARDING；一个ALTE (Alternate)端口, DISCARDING；连接PC的DESI端口, FORWARDING (BPDU保护)。
    *   `display stp`：查看详细生成树信息，确认根桥ID和类型 (Primary root)。

---

**总结**
VLAN扩展规划涉及VLAN间路由和环路避免。三层交换机通过SVI实现VLAN间路由。STP及其演进RSTP是解决交换网络环路的关键技术，RSTP通过优化端口角色、状态和收敛机制，大大提高了网络的收敛速度和稳定性。边缘端口、BPDU保护、根保护等特性进一步增强了网络的健壮性和安全性。

---

**思考题** (参考P67)
1.  RSTP定义了几种端口状态？ **B. 3** (Discarding, Learning, Forwarding)
2.  RSTP定义了哪些端口角色？ (根端口 RP, 指定端口 DP, 预备端口 AP, 备份端口 BP。还有边缘端口特性，以及管理上的Disabled端口)

---