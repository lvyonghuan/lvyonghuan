# 多协议标签交换 (MPLS) 详解

## 一、MPLS 概述

**多协议标签交换 (Multi-Protocol Label Switching, MPLS)** 是一种在开放系统互联 (OSI) 模型中介于第二层（数据链路层）和第三层（网络层）之间的高性能数据包转发技术。它通过使用短而定长的“标签”来指导数据包通过网络，而不是依赖复杂的三层IP地址查找。

*   **多协议 (Multi-Protocol):**
    *   **网络层协议:** MPLS 可以承载多种网络层协议的数据包，如 IP (IPv4, IPv6)、IPX、AppleTalk 等（尽管现在主要用于 IP）。
    *   **链路层协议:** MPLS 可以在多种链路层技术之上运行，如以太网 (Ethernet)、ATM、帧中继 (Frame Relay)、POS (Packet Over SONET/SDH) 等。
*   **标签 (Label):**
    *   MPLS 的核心是在数据包进入 MPLS 网络时，在数据包的二层头部和三层头部之间插入一个或多个固定长度（通常为4字节）的标签，这个标签被称为“MPLS Shim Header”。
    *   标签本身是一个小整数，用于在 MPLS 网络内部进行快速转发决策。标签交换路由器 (LSR) 根据标签值在其标签转发表 (LFIB) 中查找下一跳和出标签，而不是进行 IP 路由查找。
    *   **标签结构 (4字节):**
        *   **标签值 (Label):** 20位，用于标识一个转发等价类 (FEC)。
        *   **试验位 (EXP - Experimental Use):** 3位，通常用于服务等级 (CoS - Class of Service)，影响数据包的排队和丢弃优先级。
        *   **栈底位 (S - Bottom of Stack):** 1位，如果为1，表示这是标签栈中的最后一个标签；如果为0，表示后面还有其他标签（用于标签嵌套，如 MPLS VPN）。
        *   **生存时间 (TTL - Time To Live):** 8位，与 IP TTL 类似，用于防止数据包在网络中无限循环。

**MPLS 与 IP 的关系:**
MPLS **并非取代 IP**，而是作为一种 **IP 增强技术**。它利用 IP 路由协议（如 OSPF, IS-IS, BGP）来建立和分发标签信息，同时为 IP 网络带来了传统 IP 路由难以实现或效率较低的功能。

## 二、MPLS 核心组件与概念

*   **标签交换路由器 (LSR - Label Switching Router):** 能够识别 MPLS 标签并根据标签进行转发决策的路由器。
*   **边缘标签交换路由器 (LER - Label Edge Router):** 位于 MPLS 网络边缘的 LSR。
    *   **入口 LER (Ingress LER):** 负责接收来自非 MPLS 网络的数据包，根据其目标 IP 地址（或其他标准）将其映射到一个转发等价类 (FEC)，为其压入 (Push) 一个或多个 MPLS 标签，然后将其转发到 MPLS 网络内部。
    *   **出口 LER (Egress LER):** 负责将 MPLS 数据包的标签弹出 (Pop)，并根据其 IP 头部将其转发到非 MPLS 网络。
*   **标签交换路径 (LSP - Label Switched Path):** 数据包在 MPLS 网络中从入口 LER 到出口 LER 所经过的单向路径。LSP 是通过一系列 LSR 上的标签交换操作建立起来的。
*   **转发等价类 (FEC - Forwarding Equivalence Class):**
    *   一组具有相同转发处理方式（即被映射到相同 LSP，使用相同标签）的数据包的集合。
    *   FEC 的划分标准可以很灵活：
        *   **第三层网络分类 (最常见):** 基于目标 IP 地址前缀。例如，所有去往 `10.1.1.0/24` 的数据包属于同一个 FEC。
        *   **第四层分类:** 基于目标 IP 地址前缀、协议类型 (TCP/UDP) 和端口号。例如，所有去往 `10.1.1.10` 的 HTTP 流量 (TCP 端口 80)。
        *   **第五层分类 (较少直接用于 FEC 定义):** 理论上可以基于应用层信息，但实际中 MPLS 主要关注 L3/L4 信息。
        *   **其他:** 基于 VPN 标识符、流量工程参数等。
*   **标签分发协议 (LDP - Label Distribution Protocol):**
    *   LSR 之间用于交换标签与 FEC 绑定信息的信令协议。LDP 基于底层 IGP（如 OSPF, IS-IS）建立的路由信息来为 FEC 分配和通告标签。
    *   其他标签分发方式还包括 RSVP-TE (用于流量工程) 和 BGP (用于 MPLS VPN 和跨域标签分发)。
*   **标签信息库 (LIB - Label Information Base):** LSR 上存储所有已学习到的标签与 FEC 绑定信息的数据库。
*   **标签转发表 (LFIB - Label Forwarding Information Base):** 根据 LIB 和 IGP 路由表生成，用于实际的标签转发。它指示对于一个入标签，应该执行什么操作（如交换为哪个出标签、转发到哪个下一跳接口）。

## 三、MPLS 工作原理

1.  **LSP 建立 (标签分发):**
    *   LSR 使用 IGP（如 OSPF, IS-IS）学习网络拓扑和 IP 路由。
    *   LSR 使用标签分发协议 (如 LDP) 为其 IGP 路由表中的 FEC（通常是 IP 前缀）分配本地标签，并将这些标签与 FEC 的绑定关系通告给相邻的 LSR。
    *   通过这种方式，从入口 LER 到出口 LER 的一条 LSP 就被隐式地建立起来了。
2.  **数据包转发:**
    *   **标签压入 (Push):** 当一个 IP 数据包到达入口 LER 时，LER 根据数据包的目标 IP 地址（或其他 FEC 标准）查找匹配的 FEC，为其压入相应的 MPLS 标签，然后将带有标签的数据包转发到 LSP 的下一跳 LSR。
    *   **标签交换 (Swap):** MPLS 网络内部的 LSR 收到带有标签的数据包后，根据入标签在 LFIB 中查找，将入标签替换为出标签，并将数据包转发到 LSP 的下一跳 LSR。这个过程非常快速，因为它是基于固定长度标签的精确匹配，而不是复杂的 IP 最长前缀匹配。
    *   **标签弹出 (Pop):**
        *   **倒数第二跳弹出 (PHP - Penultimate Hop Popping):** 为了减轻出口 LER 的负担（避免一次标签查找和一次 IP 路由查找），LSP 的倒数第二跳 LSR 在将数据包转发给出口 LER 之前，会弹出 MPLS 标签。这样出口 LER 收到的就是纯 IP 数据包，可以直接进行 IP 路由查找。PHP 是 LDP 的默认行为。
        *   如果未使用 PHP，则出口 LER 负责弹出标签并进行 IP 转发。

## 四、MPLS 的主要特点与优势

*   **高性能转发:** 基于标签的交换比基于 IP 地址的最长前缀匹配查找更快，尤其适合硬件实现。
*   **流量工程 (TE - Traffic Engineering):**
    *   允许网络管理员显式地控制数据流在网络中的路径，而不是完全依赖 IGP 的最短路径计算。
    *   可以通过 RSVP-TE 等协议建立具有特定带宽保证、路径约束的 LSP，优化网络资源利用率，避免拥塞。
*   **服务质量 (QoS - Quality of Service):**
    *   MPLS 标签中的 EXP 位可以用来标记数据包的优先级，LSR 可以根据 EXP 位对不同类型的数据包提供差分服务（如优先排队、低延迟转发）。
    *   结合流量工程，可以为对延迟、抖动、带宽敏感的应用（如 VoIP、视频会议）提供端到端的 QoS 保障。
*   **虚拟专用网络 (VPN - Virtual Private Network):**
    *   **MPLS L3VPN (BGP/MPLS IP VPN):** 允许服务提供商在其共享的 IP/MPLS 骨干网上为多个客户构建隔离的、安全的私有三层路由域。客户可以使用重叠的 IP 地址空间。这是 MPLS 最成功的应用之一。
    *   **MPLS L2VPN:** 允许服务提供商在其骨干网上为客户提供二层连接服务，如虚拟专线 (VPWS/EoMPLS - Ethernet over MPLS) 和虚拟专用局域网服务 (VPLS)。
*   **快速重路由 (FRR - Fast Reroute):**
    *   当网络中发生链路或节点故障时，MPLS 可以提供比传统 IP 路由更快的故障恢复机制（通常在 50ms 内）。
    *   通过预先计算和建立备份 LSP，一旦主 LSP 发生故障，流量可以迅速切换到备份 LSP，减少业务中断时间。
*   **可扩展性:** MPLS 核心网络对客户路由信息不感知（在 L3VPN 中），提高了核心网络的可扩展性。
*   **多业务承载:** 能够在一个统一的 MPLS 平台上承载多种业务类型（数据、语音、视频）。

## 五、段路由选择协议 (Segment Routing - SR-MPLS)

段路由 (SR) 是一种现代的源路由技术，它简化了网络操作，并为流量工程提供了更大的灵活性。SR 可以与 MPLS 数据平面 (SR-MPLS) 或 IPv6 数据平面 (SRv6) 结合使用。

*   **核心思想:** SR 将网络路径分解为一系列“段 (Segment)”。每个段由一个段标识符 (SID - Segment Identifier) 表示。在 SR-MPLS 中，SID 直接映射为 MPLS 标签。
*   **路径指定:** 由源节点（或网络控制器）为发送的报文指定路径，并将路径转换为一个有序的 SID 列表（即 MPLS 标签栈），封装在分组首部。
*   **转发机制:** 网络中的其他节点只需根据数据包头部最外层的 SID (MPLS 标签) 执行相应的指令进行转发。当一个段的处理完成后，该 SID (标签) 被弹出，暴露出下一个 SID (标签) 进行处理。
*   **与传统 MPLS 的区别:**
    *   **无 LDP/RSVP-TE 状态:** SR 通常不依赖 LDP 或 RSVP-TE 在中间节点维护每个 LSP 的状态。SID 信息通过 IGP 扩展 (ISIS-SR, OSPF-SR) 或 BGP (BGP-LS, BGP EPE) 进行分发。这大大减少了网络中的信令开销和状态维护。
    *   **简化控制平面:** 控制平面更加简化和集中化（尤其是在 SDN 环境下）。
    *   **更强的流量工程能力:** 源路由的特性使得流量路径控制更加灵活和精确。
*   **常见的 SID 类型 (SR-MPLS):**
    *   **前缀 SID (Prefix-SID):** 代表到达某个 IGP 前缀（如一个路由器 Loopback 地址）的最短路径。通常是全局唯一的。
    *   **邻接 SID (Adjacency-SID):** 代表某个 LSR 到其直连邻居的特定链路。通常是本地唯一的。
    *   **节点 SID (Node-SID):** 通常是分配给路由器 Loopback 接口的前缀 SID，用于标识一个节点。

SR 正在成为下一代网络架构（如 5G 承载网、数据中心互联）的关键技术之一。

## 六、MPLS 配置案例 (Cisco IOS 示例)

### 案例 1: 基本 LDP MPLS 网络配置

假设有三台路由器 R1, R2, R3 线性连接: R1 -- R2 -- R3。
我们将在这三台路由器上启用 MPLS 和 LDP。

**网络拓扑与 IP 地址规划:**
*   R1:
    *   Loopback0: 1.1.1.1/32
    *   Gig0/0 (to R2): 10.1.12.1/24
*   R2:
    *   Loopback0: 2.2.2.2/32
    *   Gig0/0 (to R1): 10.1.12.2/24
    *   Gig0/1 (to R3): 10.1.23.2/24
*   R3:
    *   Loopback0: 3.3.3.3/32
    *   Gig0/1 (to R2): 10.1.23.3/24

**配置步骤:**

1.  **配置 IP 地址和 IGP (以 OSPF 为例):**
    确保所有路由器之间 IP 连通，并且 IGP 正常工作，Loopback 地址在 IGP 中通告。

    **R1 配置:**
    ```routeros
    enable
    configure terminal
    !
    hostname R1
    !
    interface Loopback0
     ip address 1.1.1.1 255.255.255.255
    !
    interface GigabitEthernet0/0
     ip address 10.1.12.1 255.255.255.0
     no shutdown
    !
    router ospf 1
     router-id 1.1.1.1
     network 1.1.1.1 0.0.0.0 area 0
     network 10.1.12.0 0.0.0.255 area 0
    !
    end
    ```

    **R2 配置:**
    ```routeros
    enable
    configure terminal
    !
    hostname R2
    !
    interface Loopback0
     ip address 2.2.2.2 255.255.255.255
    !
    interface GigabitEthernet0/0
     ip address 10.1.12.2 255.255.255.0
     no shutdown
    !
    interface GigabitEthernet0/1
     ip address 10.1.23.2 255.255.255.0
     no shutdown
    !
    router ospf 1
     router-id 2.2.2.2
     network 2.2.2.2 0.0.0.0 area 0
     network 10.1.12.0 0.0.0.255 area 0
     network 10.1.23.0 0.0.0.255 area 0
    !
    end
    ```

    **R3 配置:**
    ```routeros
    enable
    configure terminal
    !
    hostname R3
    !
    interface Loopback0
     ip address 3.3.3.3 255.255.255.255
    !
    interface GigabitEthernet0/1
     ip address 10.1.23.3 255.255.255.0
     no shutdown
    !
    router ospf 1
     router-id 3.3.3.3
     network 3.3.3.3 0.0.0.0 area 0
     network 10.1.23.0 0.0.0.255 area 0
    !
    end
    ```

2.  **全局启用 CEF (Cisco Express Forwarding):**
    MPLS 依赖 CEF。在 Cisco 路由器上通常默认开启，但最好确认。
    ```routeros
    R1(config)# ip cef
    R2(config)# ip cef
    R3(config)# ip cef
    ```

3.  **全局启用 MPLS IP:**
    ```routeros
    R1(config)# mpls ip
    R2(config)# mpls ip
    R3(config)# mpls ip
    ```
    或者在较新版本 IOS 中，`mpls label protocol ldp` 会隐式启用 `mpls ip`。

4.  **在参与 MPLS 的接口上启用 MPLS IP 和 LDP:**
    LDP 通常基于 IGP 发现的邻居自动建立会话。

    **R1 配置:**
    ```routeros
    R1(config)# interface GigabitEthernet0/0
    R1(config-if)# mpls ip
    ! 或者 mpls label protocol ldp (如果只想用LDP)
    ```

    **R2 配置:**
    ```routeros
    R2(config)# interface GigabitEthernet0/0
    R2(config-if)# mpls ip
    R2(config)# interface GigabitEthernet0/1
    R2(config-if)# mpls ip
    ```

    **R3 配置:**
    ```routeros
    R3(config)# interface GigabitEthernet0/1
    R3(config-if)# mpls ip
    ```
    *注意: 某些 IOS 版本中，`mpls ip` 在接口上配置后，LDP 会自动在该接口上运行。也可以显式配置 LDP，例如 `mpls ldp autoconfig` 配合 IGP，或者手动指定 LDP router-id `mpls ldp router-id Loopback0 force`。*

**验证 MPLS LDP:**
*   `show mpls ldp neighbor`: 查看 LDP 邻居关系是否建立。
    ```
    R1# show mpls ldp neighbor
        Peer LDP Ident: 2.2.2.2:0; Local LDP Ident 1.1.1.1:0
            TCP connection: 2.2.2.2.646 - 1.1.1.1.11060
            State: Oper; Msgs sent/rcvd: 9/9; Downstream
            Up time: 00:05:00
            LDP discovery sources:
              GigabitEthernet0/0, Src IP addr: 10.1.12.2
            Addresses bound to peer LDP Ident:
              10.1.12.2       2.2.2.2         10.1.23.2
    ```
*   `show mpls forwarding-table`: 查看 LFIB，即标签转发表。
    ```
    R1# show mpls forwarding-table
    Local      Outgoing   Prefix           Bytes Label   Outgoing   Next Hop
    Label      Label      or Tunnel Id     Switched      interface
    16         Pop Label  3.3.3.3/32       0             Gi0/0      10.1.12.2
    17         16         2.2.2.2/32       0             Gi0/0      10.1.12.2
    ```
    (输出会显示本地标签、出标签、目标前缀、下一跳等信息。例如，R1 去往 3.3.3.3/32 的数据包，会压入本地标签16，下一跳是 R2，R2 会将标签16交换为另一个标签或弹出标签。)
*   `show mpls ldp bindings`: 查看 LDP 标签绑定信息。
*   `traceroute <destination_ip>`: 从 R1 `traceroute 3.3.3.3`，应该能看到 MPLS 标签的显示（如果中间设备支持显示）。
    ```
    R1# traceroute 3.3.3.3 source loopback0
    Type escape sequence to abort.
    Tracing the route to 3.3.3.3
      1 10.1.12.2 [MPLS: Label 16 Exp 0] 8 msec 8 msec 8 msec
      2 10.1.23.3 8 msec *  8 msec
    ```
    这里 `[MPLS: Label 16 Exp 0]` 表明 R2 (10.1.12.2) 是基于 MPLS 标签 16 进行转发的。由于 PHP，R2 发往 R3 时会弹出标签。

### 案例 2: 基本 MPLS L3VPN 配置 (简化)

MPLS L3VPN 允许客户在服务提供商的 MPLS 骨干网上运行独立的路由域。
**核心组件:**
*   **PE (Provider Edge) Router:** 服务提供商边缘路由器，直接连接客户设备 (CE)。
*   **P (Provider) Router:** 服务提供商核心路由器，不直接连接 CE，只负责 MPLS 标签交换。
*   **CE (Customer Edge) Router:** 客户边缘路由器。
*   **VRF (VPN Routing and Forwarding instance):** PE 路由器上为每个 VPN 客户创建的虚拟路由表和转发表。
*   **MP-BGP (Multi-Protocol BGP):** 用于在 PE 路由器之间分发 VPN 路由信息 (VPNv4/VPNv6 前缀)。

**简化拓扑:** CE1 -- PE1 -- P -- PE2 -- CE2
*   PE1, P, PE2 构成 MPLS 核心网，运行 IGP 和 LDP (如案例1)。
*   PE1 和 PE2 之间运行 MP-iBGP。
*   PE 和 CE 之间运行标准的路由协议 (如静态、RIP、OSPF、eBGP)。

**PE1 上的 VRF 和 BGP 配置 (概念性):**
```routeros
! --- PE1 Configuration ---
hostname PE1
!
ip cef
mpls ip
mpls label protocol ldp
!
! IGP Configuration (e.g., OSPF with P router)
router ospf 1
 router-id <PE1_loopback_ip>
 network <PE1_core_facing_network> <wildcard> area 0
 network <PE1_loopback_network> <wildcard> area 0
!
! VRF Definition for Customer_A
ip vrf Customer_A
 rd 100:1  ! Route Distinguisher (makes customer prefixes globally unique)
 route-target export 100:1 ! Export RT
 route-target import 100:1 ! Import RT
!
! Interface connecting to CE1 for Customer_A
interface GigabitEthernet0/1 ! To CE1
 ip vrf forwarding Customer_A
 ip address <ip_for_ce1_link> <subnet_mask>
!
! BGP Configuration
router bgp <AS_Number_Provider>
 bgp router-id <PE1_loopback_ip>
 neighbor <P_router_loopback_ip> remote-as <AS_Number_Provider> ! iBGP to P or RR
 neighbor <P_router_loopback_ip> update-source Loopback0
 neighbor <PE2_loopback_ip> remote-as <AS_Number_Provider>  ! iBGP to PE2
 neighbor <PE2_loopback_ip> update-source Loopback0
 !
 ! Address Family for VPNv4 (to exchange VPN routes with other PEs)
 address-family vpnv4
  neighbor <PE2_loopback_ip> activate
  neighbor <PE2_loopback_ip> send-community extended
 exit-address-family
 !
 ! Address Family for Customer_A VRF (to exchange routes with CE1)
 address-family ipv4 vrf Customer_A
  neighbor <CE1_ip_on_pe_link> remote-as <AS_Number_Customer_A> ! eBGP to CE1
  neighbor <CE1_ip_on_pe_link> activate
  ! Or redistribute connected/static/ospf from CE
  ! redistribute ospf <ospf_process_id_for_vrf> metric <value>
 exit-address-family
!
end
```
**PE2 配置类似，P 路由器只需运行 IGP 和 LDP，无需 VRF 或 MP-BGP VPNv4 配置。**

**关键点:**
*   **RD (Route Distinguisher):** 附加到客户 IP 前缀上，使其在服务提供商网络中唯一，即使不同客户使用相同的私有地址。
*   **RT (Route Target):** BGP 扩展团体属性，用于控制 VPN 路由的导入和导出策略，决定哪些 VRF 可以接收哪些 VPN 路由。
*   PE 路由器将从 CE 学到的 IPv4 路由转换为 VPNv4 前缀 (RD + IPv4 前缀)，通过 MP-BGP 通告给其他 PE。
*   其他 PE 收到 VPNv4 前缀后，根据 RT 决定是否将其导入本地 VRF，并转换为 IPv4 前缀通告给相应的 CE。
*   数据包在 PE 之间通过 MPLS LSP 转发，通常使用两层标签：外层标签用于 MPLS 核心网内部转发，内层标签 (由 BGP 分配) 用于标识目标 PE 上的 VRF。

MPLS L3VPN 配置较为复杂，涉及多个协议的协同工作，以上仅为概念性展示。

## 七、总结

MPLS 通过引入标签交换机制，极大地增强了传统 IP 网络的能力，提供了高性能转发、强大的流量工程、灵活的 VPN 构建以及快速故障恢复等特性。随着 Segment Routing 等新技术的出现，MPLS 依然在现代网络中扮演着至关重要的角色。