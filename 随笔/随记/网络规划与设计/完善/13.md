# 动态路由协议原理

## 一、动态路由协议概述

动态路由协议允许路由器自动学习和发现网络拓扑，并根据网络变化动态调整路由表。与静态路由相比，动态路由协议具有以下优势：
*   **自动路由发现机制:** 无需手动配置每一条路由，减轻了管理员负担，尤其适用于大型和复杂网络。
*   **网络变化自适应:** 当网络拓扑发生变化（如链路故障或新增链路）时，动态路由协议能够自动更新路由信息，保证数据包的正确转发。
*   **可扩展性:** 更易于扩展网络规模。

**关键考量因素:**
*   **度量标准 (Metric):** 衡量到达目的网络的“成本”或“优劣程度”，如跳数、带宽、延迟、负载、可靠性等。不同协议使用不同的度量标准。
*   **收敛时间 (Convergence Time):** 当网络拓扑发生变化后，所有路由器就新的拓扑达成一致并更新路由表所需的时间。收敛时间越短，协议性能越好。
*   **算法复杂度:** 协议计算路径的算法复杂程度，影响路由器的资源消耗（CPU、内存）。
*   **资源消耗:** 协议运行本身占用的带宽、CPU 和内存资源。

## 二、常见的动态路由协议

### 1. RIP (Routing Information Protocol) - 距离矢量协议

RIP 是一种相对简单的内部网关协议 (IGP)，基于距离矢量算法。

*   **度量标准:** 跳数 (Hop Count)，即到达目标网络需要经过的路由器数量。最大有效跳数为 15，16 跳表示网络不可达。
*   **工作机制:**
    *   **周期性广播/组播:** 默认每 30 秒向邻居发送完整的路由表更新信息。
    *   **邻居交换路由表:** 路由器从邻居学习路由，并将其添加到自己的路由表中。
*   **计时器:**
    *   **更新计时器 (Update Timer):** 默认 30 秒，路由器发送路由更新的时间间隔。
    *   **无效计时器 (Invalid Timer / Timeout Timer):** 默认 180 秒。如果在该时间内未收到来自某个邻居的关于某条路由的更新，则认为该路由无效，将其跳数标记为 16。
    *   **刷新计时器 (Flush Timer / Garbage-Collection Timer):** 默认 240 秒 (通常是无效计时器 + 60s 或 120s，不同实现可能不同)。在路由被标记为无效后，再等待该时间，如果仍未收到更新，则从路由表中彻底删除该条目。
    *   **抑制计时器 (Hold-down Timer):** 当一条路由的度量值增加或变为不可达时，路由器会启动抑制计时器（例如 180 秒）。在抑制期间，路由器不会接受关于这条路由的、度量值比之前更大的更新信息，以防止路由抖动（路由条目在可用和不可用状态之间快速切换）。
*   **“好消息传得快，坏消息传得慢” 问题:** 当网络出现故障导致路由不可达时，该信息需要逐跳、逐周期地传播，收敛速度较慢。
*   **环路避免机制:**
    *   **水平分割 (Split Horizon):** 路由器从某个接口学到的路由信息，不会再通过该接口发送回去。这是为了防止两节点间的路由环路。
        *   **注意:** 在某些环形拓扑中（例如多于两个路由器的环路），单纯的水平分割可能无法完全避免计数到无穷大问题。
    *   **毒性逆转 (Poison Reverse / Route Poisoning):** 当一条路由变为不可达时，路由器会立即向其邻居通告该路由，并将其跳数设置为 16（表示不可达）。收到此信息的路由器会立即将该路由标记为不可达，而不是等待其老化。这是水平分割的增强。
    *   **触发更新 (Triggered Updates):** 当路由表发生变化时（如收到新的路由信息或检测到链路故障），路由器立即向邻居发送更新信息，而不必等待下一个更新周期。这可以加速网络收敛。
*   **局限性:**
    *   **慢收敛:** 尤其是在大型网络或网络故障时。
    *   **规模限制:** 最大跳数为 15，限制了网络直径。
    *   **基于跳数的度量标准过于简单:** 不能反映链路带宽、延迟等实际情况。
    *   **周期性发送完整路由表:** 占用网络带宽。

#### RIPv1
*   **有类路由协议:** 在路由更新时不携带子网掩码信息。
*   **不支持 VLSM (Variable Length Subnet Masking) 和 CIDR (Classless Inter-Domain Routing)。**
*   **不支持不连续子网 (Discontiguous Subnets):** 如果一个主类网络被划分为多个子网，而这些子网之间被另一个主类网络隔开，RIPv1 可能无法正确识别所有子网。
*   **更新方式:** 使用广播地址 (255.255.255.255) 发送路由更新。

#### RIPv2
*   **无类路由协议:** 在路由更新时携带子网掩码信息。
*   **支持 VLSM 和 CIDR。**
*   **支持不连续子网。**
*   **更新方式:** 使用组播地址 (224.0.0.9) 发送路由更新，减少了对不运行 RIP 的主机的干扰。
*   **支持认证:** 可以对路由更新信息进行简单的明文或 MD5 认证，增加安全性。

### 2. OSPF (Open Shortest Path First) - 链路状态协议

OSPF 是一种广泛使用的内部网关协议 (IGP)，基于链路状态算法，采用 Dijkstra 算法计算最短路径。

*   **度量标准:** 成本 (Cost)，通常与链路带宽成反比 (Cost = 参考带宽 / 接口带宽)。管理员也可以手动配置接口成本。
*   **工作机制:**
    *   **邻居关系建立:** 通过发送 Hello 包发现邻居并建立邻接关系。
    *   **链路状态通告 (LSA - Link State Advertisement):** 每台路由器产生描述自身链路状态（如连接的邻居、接口 IP、成本等）的 LSA。
    *   **链路状态数据库 (LSDB - Link State Database):** 每台路由器都维护一个包含区域内所有 LSA 的 LSDB，从而拥有整个区域的网络拓扑图。
    *   **SPF 算法 (Shortest Path First):** 每台路由器基于 LSDB 独立运行 SPF 算法，计算出以自身为根的最短路径树，生成路由表。
*   **区域 (Area):** OSPF 允许将大型网络划分为多个区域，以减小 LSDB 的规模和 SPF 计算的复杂性，提高可扩展性。
    *   **骨干区域 (Area 0 / Backbone Area):** 所有其他非骨干区域必须直接连接到骨干区域。区域间的路由通过骨干区域转发。
    *   **ABR (Area Border Router):** 连接骨干区域和其他区域的路由器。
    *   **ASBR (Autonomous System Boundary Router):** 连接 OSPF 自治系统与其他自治系统（如运行其他路由协议的网络）的路由器。
*   **路由器角色 (DR/BDR):** 在多路访问网络（如以太网）中，为减少 LSA 的泛洪数量和邻接关系的数量，会选举一个指定路由器 (DR - Designated Router) 和一个备份指定路由器 (BDR - Backup Designated Router)。该网段内的其他路由器 (DROther) 只与 DR 和 BDR 建立完全邻接关系并交换 LSA。
*   **优点:**
    *   **快速收敛:** 当网络拓扑变化时，只泛洪变化的 LSA，收敛速度快。
    *   **无环路:** 由于每台路由器都拥有完整的拓扑信息，不易产生路由环路。
    *   **支持 VLSM 和 CIDR。**
    *   **支持大规模网络:** 通过区域划分实现。
    *   **基于成本的灵活度量标准。**
    *   **支持认证。**
*   **更新方式:** 使用触发式更新，当链路状态变化时才发送 LSA。Hello 包周期性发送以维护邻居关系。LSA 使用组播地址 (224.0.0.5 给所有 OSPF 路由器，224.0.0.6 给 DR/BDR)。

### 3. EIGRP (Enhanced Interior Gateway Routing Protocol) - 高级距离矢量/混合型协议

EIGRP 是 Cisco 私有的路由协议，结合了距离矢量和链路状态协议的优点，通常被称为高级距离矢量协议或混合型协议。

*   **度量标准:** 复合度量值，默认基于带宽 (Bandwidth) 和延迟 (Delay)。还可以包括负载 (Load)、可靠性 (Reliability) 和 MTU (较少使用)。
*   **工作机制:**
    *   **邻居发现与维护:** 通过 Hello 包发现和维护邻居关系。
    *   **DUAL (Diffusing Update Algorithm):** 核心算法，用于无环路路径计算和快速收敛。
        *   **可行后继路由器 (Feasible Successor - FS):** 到达目标网络的备用路径，且满足可行性条件（其通告距离小于当前后继路由器的可行距离），确保无环。
        *   **后继路由器 (Successor):** 到达目标网络的最佳路径。
    *   **拓扑表 (Topology Table):** 存储从邻居学习到的所有到达目标网络的路径信息，包括后继路由器和可行后继路由器。
    *   **路由表 (Routing Table):** 存储到达每个目标网络的最佳路径（后继路由器）。
*   **优点:**
    *   **快速收敛:** 当主路径失效时，如果存在可行后继路由器，可以立即切换，无需重新计算。
    *   **支持 VLSM 和 CIDR。**
    *   **支持多种网络层协议 (如 IP, IPX, AppleTalk)，尽管现在主要用于 IP。**
    *   **部分更新和有界更新:** 只发送变化的路由信息，并且只发送给受影响的路由器，减少带宽消耗。
    *   **负载均衡:** 支持等价和非等价路径负载均衡。
*   **更新方式:** 采用触发式更新。使用可靠传输协议 (RTP - Reliable Transport Protocol) 来确保 EIGRP 报文的可靠传递。使用组播地址 (224.0.0.10)。

## 三、有类路由协议 (Classful) 与无类路由协议 (Classless)

*   **有类路由协议:**
    *   在路由信息更新过程中 **不发送子网掩码**。
    *   路由器根据接收接口的 IP 地址和其所属的主类网络掩码，或者根据路由条目本身所属的主类网络掩码来判断子网掩码。
    *   不支持 VLSM 和 CIDR。
    *   容易在不连续子网环境中产生路由问题。
    *   **示例:** RIPv1, IGRP (EIGRP 的前身)。
*   **无类路由协议:**
    *   在路由信息更新过程中 **发送子网掩码** (通常以 前缀长度 的形式)。
    *   能够精确地表示每个子网的范围。
    *   支持 VLSM 和 CIDR，允许更有效地利用 IP 地址空间。
    *   **示例:** RIPv2, EIGRP, OSPF, IS-IS, BGP。

## 四、路由信息交换机制

*   **周期性更新 (Periodic Updates):**
    *   路由器按照固定的时间间隔向邻居发送路由更新信息（通常是完整的路由表）。
    *   **缺点:** 即使网络拓扑没有变化，也会消耗带宽；收敛速度相对较慢。
    *   **示例:** RIP。
*   **触发式更新 (Triggered Updates / Event-Driven Updates):**
    *   当网络拓扑发生变化时（如链路 UP/DOWN，路由度量值改变），路由器立即发送更新信息。
    *   **优点:** 反应迅速，收敛快，节省带宽。
    *   通常与周期性的 Hello 机制或 LSA 刷新机制结合使用以维护邻居关系和数据库同步。
    *   **示例:** OSPF, EIGRP (RIPv2 也支持触发更新作为辅助)。
*   **邻居发现与维护:**
    *   动态路由协议通常具有发现直连邻居并与之建立和维护邻接关系的机制。
    *   通常通过周期性发送 Hello 包来实现。如果一段时间内未收到邻居的 Hello 包，则认为邻居不可达。

## 五、总结对比

| 特性         | RIP (v1/v2)                      | OSPF                                     | EIGRP (Cisco)                             |
| :----------- | :------------------------------- | :--------------------------------------- | :---------------------------------------- |
| **类型**     | 距离矢量                         | 链路状态                                 | 高级距离矢量 (混合型)                     |
| **算法**     | Bellman-Ford                     | Dijkstra (SPF)                           | DUAL                                      |
| **度量标准** | 跳数                             | 成本 (基于带宽)                          | 复合度量 (带宽, 延迟, 可靠性, 负载)       |
| **收敛速度** | 慢                               | 快                                       | 非常快                                    |
| **VLSM/CIDR**| v1:不支持; v2:支持               | 支持                                     | 支持                                      |
| **网络规模** | 小型                             | 大型                                     | 中到大型                                  |
| **更新方式** | v1:广播(周期); v2:组播(周期+触发) | 组播 (触发式LSA, 周期性Hello)            | 组播 (触发式, 可靠传输)                   |
| **环路避免** | 水平分割, 毒性逆转, 抑制计时器   | LSDB拓扑图, SPF计算                      | DUAL算法, 可行后继                        |
| **资源消耗** | 低                               | 中到高 (CPU, 内存)                       | 中等                                      |
| **标准化**   | 开放标准                         | 开放标准                                 | Cisco私有 (部分已开放)                    |
| **复杂性**   | 简单                             | 复杂                                     | 中等                                      |